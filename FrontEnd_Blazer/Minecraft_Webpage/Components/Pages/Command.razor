@page "/Command"
@using Minecraft_Webpage.Data
@using Minecraft_Webpage.Data.Player
@using static System.Net.WebRequestMethods
@inject CommandService CommandService
@inject HttpClient Http
@rendermode InteractiveServer

<h3>Command Log</h3>



<details>
    <summary class="bubble">Show Commands</summary>

    <div class="cmd-list">
        @foreach (var cmd in commands)
        {
            <div @onclick="() => ShowBubbleMapped(cmd)">
                @cmd.CommandText
            </div>
        }
    </div>

    @if (selectedDescription != null)
    {
        <div class="bubble">
            @selectedDescription
        </div>
    }
</details>

<h4>Command Input</h4>
<div class="logsStyles_Input">
    <EditForm Model="_message" OnValidSubmit="HandleSend" FormName="grass">
        <div class="input-group">
            <InputText @bind-Value="_message.Text" placeholder="Enter command" class="input-field" />
            <button type="submit" class="send-btn">Send</button>
        </div>
    </EditForm>
</div>

@code {

    private List<CommandEntry> commandHistory = new List<CommandEntry>();
    private Message _message = new Message();

    private List<Minecraft_Webpage.Data.Command> commands = new();
    string? selectedDescription;

    protected override void OnInitialized()
    {
        commands = CommandService.GetCommands();
    }

   

    private async Task HandleSend()
    {
        var text = _message?.Text;

        if (string.IsNullOrWhiteSpace(text))
            return;

        // 1. Validate
        var validateResponse = await Http.PostAsJsonAsync("http://localhost:3000/validate", new
        {
            command = text
        });

        var validation = await validateResponse.Content.ReadFromJsonAsync<ValidationResult>();

        if (validation == null || !validation.ok)
        {
            // add to your history as an error result
            commandHistory.Add(new CommandEntry
            {
                Text = text,
                Timestamp = DateTime.Now,
                Result = validation?.error ?? "Unknown validation error"
            });

            _message.Text = "";
            return;
        }

        // 2. Send to RCON API
        var rconResponse = await Http.PostAsJsonAsync("http://localhost:3000/rcon", new
        {
            command = text

        });

        var rcon = await rconResponse.Content.ReadFromJsonAsync<RconResult>();

        commandHistory.Add(new CommandEntry
        {
            Text = text,
            Timestamp = DateTime.Now,
            Result = rcon?.result ?? rcon?.error ?? "Unknown RCON error"
        });

        _message.Text = "";
    }


    public class Message
    {
        public string Text { get; set; } = "";
    }

    public class CommandEntry
    {
        public string command { get; set; }
        public string description { get; set; }
        public string? Result { get; set; }
        public string Text { get; set; } = "";
        public DateTime Timestamp { get; set; }
    }



    void ShowBubbleMapped(Minecraft_Webpage.Data.Command cmd)
    {
        selectedDescription = cmd.Description;
        var entry = new CommandEntry
        {

            // map fields
            command = cmd.CommandText,

            description = cmd.Description,

            Text = cmd.CommandText,

            Timestamp = DateTime.Now

        };
    }

    public class ValidationResult
    {
        public bool ok { get; set; }
        public string? error { get; set; }
    }

    public class RconResult
    {
        public bool ok { get; set; }
        public string? result { get; set; }
        public string? error { get; set; }
    }

}